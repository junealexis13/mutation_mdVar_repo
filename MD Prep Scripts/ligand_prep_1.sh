#!/bin/bash

LNK=$1
RESN=$2
STR=$3
FF=$4

mini-help () {
echo "
Script for Creating ligand parameter files.
-------------------------------------------
Created by: June Alexis A. Santos, MS Student, AdU
"

echo "
Note: This script requires CGENFF stream files (.str) using CGENFF server.
Submit your sybyl .mol2 file to https://cgenff.umaryland.edu/ and create the 
pre-requisite file if necessary.

Usage:
First, enable executable permission by running : chmod +x ligand_prep_1.sh
Then, run the script by passing: bash ligand_prep_1.sh <ligand mol2 file> <residue name> <charmm stream file> <forcefield folder>

REQUIRED OPTIONS
ligand mol2 file   - pass directory representing the mol2 file of the ligand.

residue name (UNK) - specify the residue name of the ligand.

charmm STR file    - stream (.str) file generated by CGENFF server.

forcefield folder  - folder containing the forcefield parameters.

OPTIONAL FLAGS
-h --help          -  invoke help documentations
"
exit
}

if [[ $LNK == "-h" ]] || [[ $LNK == "--help" ]]; then
	mini-help
fi


if ! [[ -f cgenff_charmm2gmx_py3_nx2.py ]]; then
	wget -O cgenff_charmm2gmx_py3_nx2.py http://mackerell.umaryland.edu/download.php?filename=CHARMM_ff_params_files/cgenff_charmm2gmx_py3_nx2.py
	if [[ -f cgenff_charmm2gmx_py3_nx2.py ]]; then
		echo "Successfully downloaded python script"
	fi
fi


echo "
Script for Creating ligand parameter files.
-------------------------------------------
Created by: June Alexis A. Santos, MS Student, AdU
"

echo "Note: This script requires CGENFF stream files .str using CGENFF server."
echo "Submit your sybyl .mol2 file to https://cgenff.umaryland.edu/ and create the "
echo "pre-requisite file if necessary."

sleep 2

echo "-----------------------------------"
echo "Updating Python framework"

sudo apt-get update
pip install networkx==2.3
pip install numpy

python cgenff_charmm2gmx_py3_nx2.py $RESN $LNK $STR $FF || python3 cgenff_charmm2gmx_py3_nx2.py $RESN $LNK $STR $FF 

FILE=$(basename $LNK)
FNAME=${FILE/"mol2"/"gro"}

echo "Running Gromacs command.
Editing the output pdb from python script.
"

if [[ -f $(find *_ini.pdb) ]]; then
	gmx editconf -f $(find *_ini.pdb) -o $FNAME
fi
